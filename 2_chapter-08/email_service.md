# 분산 이메일 서비스
## 도메인 지식
### 1. 이메일 프로토콜
- 이전까지 대부분의 메일 서버는 POP, IMAP, SMTP 같은 프로토콜을 사용했다.
- SMTP(Simple Mail Transfer Protocol) : 이메일을 한 서버에서 다른 서버로 보내는 표준 프로토콜
- POP(Post Office Protocol) : 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드할 때 사용하는 표준 프로토콜
- IMAP(Internet Mail Access Protocol) : 이메일 클라이언트가 원격 메일 서버에서 수신할 때 사용되는 또다른 프로토콜
    - POP는 이메일을 일부만 읽을 수 있고, 확인하기 위해선 전부 내려받는 시간이 더 소요된다. 
    - 이에 비해 IMAP은 헤더만 다운로드하여 여러 단말기에서 목록을 빠르게 보여주고, 실제로 열 때 추가 다운로드를 하기 때문에 더 빠르고 잘 동작한다.
- HTTPS: 메일 전송 프로토콜은 아니지만, 웹 기반 이메일 시스템에서 메일함 접속에 사용된다.


### 2. DNS(Domain Name Service)
- DNS 서버는 수신자 도메인의 메일 교환기 레코드(MX) 검색에 이용된다.
- MX 레코드를 보면 우선순위와 메일 서버 목록 등을 확인할 수 있다.


### 3. 첨부 파일
- 이메일 메시지에 첨부되어 전송되는 파일
- 일반적으로 Base64 인코딩을 사용한다.
- 메일 서비스에 따라 너무 큰 용량을 첨부할 수 없게 크기 제한을 두는 것이 좋다.


### 4. 전통적 메일 서버 구조
- 분산 메일 서버 설계 전에, 기존의 전통적 메일 서버의 동작 방식을 알아보자.
- 전통적 메일 서버는 보통 서버 한 대로 운용되는, 사용자가 많지 않을 때 잘 동작하는 시스템이다.
- 전통적 메일 서버는 이메일을 파일 시스템의 directory에 저장한다.
    - 이 때, 각각의 이메일은 고유한 이름을 가진 별도 파일로 보관한다.
    - 이렇게 파일과 디렉토리를 이용한 방식은 다루는 이메일 수가 많아질수록 이메일 검색, backup에 취약하다.
    - 위와 같은 상황에선 Disk I/O가 큰 병목이 되고, 가용성과 안정성도 챙길 수 없다.
    - 따라서, 메일 서비스가 확장될 때, 분산 데이터 저장소 계층이 필요해진다.


---
## 분산 메일 서버 아키텍처
- 웹메일:  사용자는 웹 브라우저를 사용해 메일을 주고 받는다.
- 웹서버: 웹서버는 사용자가 이용하는 요청/응답 서비스로 이메일 발송, 목록 확인, 메시지 확인 등 모든 관련 API 요청을 처리한다.
- 실시간 서버: 새로운 이메일 내역을 클라이언트에 실시간으로 전달한다. 지속 연결을 맺고 유지해야하기 때문에 Stateful 서버이다.
    - 실시간 통신 지원 방법으로 Long-Polling과 WebSocket이 있으며, 기본적으로 WebSocket을 쓰되, 브라우저 호환 문제가 있으면 Long-Polling을 백업 방식으로 이용할 수 있다.
- 메타데이터 DB: 이메일 제목, 본문, 발신인, 수신인 등 이메일의 메타데이터를 저장한다.
- 첨부 파일 저장소: S3 같은 객체 저장소를 사용한다.
- 분산 캐시: 최근 수신된 이메일은 자주 읽을 가능성이 높으므로 캐싱해두면 좋다.
    - 본 설계안에서는 다양한 기능을 제공하고 확장에 용이한 Redis를 사용한다.
- 검색 저장소: 분산 문서 저장소로, 고속 텍스트 검색을 지원하는 역인덱스 구조로 메일 검색에 쓰인다.


<img src="/2_chapter-08/img/distributed_mail_server_arch.png" alt="arch-1" width="60%">



---
## 이메일 전송 절차


<img src="/2_chapter-08/img/email_send_arch.png" alt="arch-2" width="70%">


1. 사용자가 웹메일 전송을 누르면, 요청이 로드밸런서로 전송된다.
2. 로드벨런서는 Rate Limiter의 한도를 넘지 않는 선에서 전송 요청을 웹서버로 전달한다.
3. 웹서버는 기본적으로 이메일을 검증하고, 스팸 여부나 바이러스 여부를 검사한다.
4. 메시지 큐
    - 기본 검증에 통과한 이메일을 외부 전송 큐로 전달한다.
    - 기본적인 검증에 실패한 이메일은 에러 큐로 보낸다.
5. SMTP 작업 프로세스: 큐에서 메시지를 꺼내어 스팸 여부와 바이러스 감염 여부를 확인한다.
6. 모든 검증이 통과하면 이메일은 저장소 계층에 저장된다.
7. 마지막으로, SMTP가 수신자의 메일 서버로 메일을 전송한다.



### 추가로 주의할 점
- 메일이 처리되지 않고 큐에 오래 남아있는 경우를 잘 모니터링해야 한다.
- 큐에 남아있는 이유를 분석하여 적절한 처리를 해줘야한다.
    - ex. 수신자측 메일 서버에 장애 발생한 경우: 나중에 메일 다시 전송(지수적 백오프 전략)
    - ex. 이메일을 보낼 큐에 달린 Consumer 수 부족: Consumer 규모를 늘려서 처리 시간 단축하기


---
## 이메일 수신 절차


<img src="/2_chapter-08/img/email_received_arch.png" alt="arch-3" width="90%">


1. 이메일이 SMTP 로드밸런서에 도착한다.
2. 로드밸런서가 트래픽을 여러 SMTP 서버로 분산한다.
3. 이메일의 첨부파일이 너무 큰 경우에는 첨부 파일 저장소에 보관한다.
4. 이메일을 수신 이메일 큐에 넣는다. (메일 처리 작업 프로세스와 SMTP 서버 사이 결합도를 느슨하게 만드는 역할, 트래픽 폭증 시 버퍼 역할)
5. 수신 절차에서도 작업 프로세스가 이메일 검증 작업을 거친다.
6. 이메일을 메일 저장소, 캐시, 객체 저장소 등에 보관한다.
7. 수신자가 온라인 상태인 경우 이메일을 실시간 서버로 전달한다.
8. 실시간 서버는 수신자 클라이언트가 새 이메일을 실시간으로 받을 수 있도록 하는 웹소켓 서버이다.
9. 오프라인 상태 사용자의 이메일은 저장 되었다가, 온라인 상태가 되면 RESTful API를 통해 연결되고 정보를 받아온다.
10. 웹서버는 새로운 이메일을 저장소 계층에서 읽어온다.



---
## 상세 설계
### 메일 데이터 베이스
- 메일 규모가 커질수록, IO 연산 빈도를 낮추기 위해 커스텀 전용 데이터베이스를 사용한다. (ex. Gmail, Outlook)
- 상용화된 DB 중에는 적합한 DB가 없고, 대형 메일 서비스업체는 자체 DB를 구축하면서 내부 구조를 공개하지 않으므로 주요 조건을 알아두자.
    - 어떤 단일 칼럼의 크기는 N MB 정도일 수 있다. (큰 크기도 감당 가능하도록)
    - 강력한 데이터 일관성이 보장되어야 한다.
    - Disk IO가 최소화되어야 한다.
    - 가용성이 아주 높아야하고, 일부 장애를 감내할 수 있는 구조가 필요하다.
    - 증분 백업이 쉬워야한다.


### 메일 검색
크게 ElasticSearch를 사용하는 것과, 맞춤형 검색 엔진을 사용하는 두 가지 방안이 있고, 각 방안의 장단점을 비교하면 다음과 같다.


| 비교 항목    | ElasticSearch            | 맞춤형 검색 엔진 (주 저장소 기반으로 직접 개발)           |
| ---------- | ------------------------- | ----------------------------------- |
| 1. 규모 확장성     | 클러스터 기반의 수평 확장 지원, 노드 추가만으로 용량·처리량 확장 가능    | 이메일 사용 패턴에 따른 자체 샤딩·분산 로직 구현 필요       |
| 2. 시스템 복잡도    | 데이터 저장소와 ElasticSearch 두 가지 상이한 시스템을 동시에 유지해야함   | 하나의 시스템으로 통합 운영   |
| 3. 데이터 일관성    | 한 데이터에 두 사본이 존재(저장소와 ElasticSearch)하여 데이터 일관성 유지 까다로움 | 주 저장소에 사본 유지하는 일관성만 체크 |
| 4. 데이터 손실 가능성 | 색인이 손상되면 주 저장소의 데이터를 사용해 복구 가능 | 주 저장소가 손상되지 않는 한 손실 가능성 없음 |
| 5. 개발 비용      | 규모가 커질수록 ElasticSearch 전담할 비용이 증가  | 초기 개발 비용, 맞춤형 솔루션 개발을 위한 엔지니어링 투자 필요  |


아래는 ElasticSearch를 활용했을 때의 설계도이다. `user_id` 를 파티션 키로 사용하여 같은 사용자의 이메일을 같은 노드에 묶어 놓는 것을 기본으로 한다.


<img src="/2_chapter-08/img/elastic_search_arch.png" alt="arch-4" width="60%">


---
## 추가 고려 사항
- 결함 내성: 다양한 장애 가능성에 대해 어떻게 대처할지 논의 필요
- 보안: 이메일에 민감 정보가 포함될 수 있으므로 다양한 보안 정책, 암호화, 브라우저 보안 체크
- 최적화: 같은 이메일이 여러 수신자에게 전송되는 경우, 같은 첨부 파일이 중복 저장되지 않도록 처리
- 법규 준수: 각 국가 별 준수해야하는 법규가 있는지, 국가별 기준에 따라 개인 식별 정보를 따로 다루기